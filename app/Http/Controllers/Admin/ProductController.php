<?php

namespace App\Http\Controllers\Admin;

use App\Models\Catalogue;
use App\Models\Images;
use App\Models\Product;
// use App\Models\Category;
use Illuminate\Support\Str;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Http\Requests\StoreProductRequest;
use App\Models\Attribute;
use App\Models\AttributeValue;
use App\Models\Brand;
use App\Models\ProductVariant;
use App\Models\ProductVariantAttribute;
use Carbon\Carbon;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;

class ProductController extends Controller
{
    public function index(Request $request)
    {
        $query = Product::query();

        // L·ªçc theo danh m·ª•c
        if ($request->has('category') && $request->category != '') {
            $query->where('catalogue_id', $request->category);
        }

        // L·ªçc theo th∆∞∆°ng hi·ªáu
        if ($request->has('brand') && $request->brand != '') {
            $query->where('brand_id', $request->brand);
        }
        // L·ªçc theo ng√†y t·∫°o
        if ($request->has('date') && $request->date != '') {
            $query->whereDate('created_at', $request->date);
        }

        // T√¨m ki·∫øm theo t√™n s·∫£n ph·∫©m
        if ($request->has('search') && $request->search != '') {
            $query->where('name', 'like', '%' . $request->search . '%');
        }
        // L·ªçc theo tr·∫°ng th√°i
        if ($request->has('status') && $request->status != '') {
            $query->where('status', $request->status);
        }

        $products = $query->with(['brand', 'catalogue'])->latest('created_at')->paginate(5);
        $categories = Catalogue::all();
        $brands = Brand::all();

        return view('admin.product.index', compact('products', 'categories', 'brands'));
    }

    public function create()
    {
        $title = 'Add Product';
        $brands = Brand::all();
        $catalogues = Catalogue::all();
        $attributes = Attribute::with('values')->get();

        return view('admin.product.add', compact('title', 'catalogues', 'brands', 'attributes'));
    }

    public function store(Request $request)
    {
        $request->validate([
            'name' => 'required|string|max:255',
            'brand_id' => 'required|exists:brands,id',
            'catalogue_id' => 'required|exists:catalogues,id',
            'origin' => 'nullable|string|max:255',
            'style' => 'nullable|string|max:255',
            'fragrance_group' => 'required|string|max:255',
            'description' => 'nullable|string',
            'image' => 'nullable|image|max:2048',
            'images.*' => 'nullable|image|max:2048',
            'variants' => 'nullable|string',
            'status' => 'required|in:1,2',
        ]);

        // Ki·ªÉm tra s·∫£n ph·∫©m tr√πng l·∫∑p
        $existingProduct = Product::where('name', $request->name)
            ->where('brand_id', $request->brand_id)
            ->first();

        if ($existingProduct) {
            return redirect()->back()
                ->withInput()
                ->with('error', 'S·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng');
        }

        $product_code = 'SP' . Carbon::now()->format('YmdHis') . rand(100, 999);

        DB::beginTransaction();
        try {
            // üì∏ X·ª≠ l√Ω ·∫£nh ch√≠nh
            $imagePath = $request->hasFile('image') ? $request->file('image')->store('products', 'public') : null;

            // üî• T·∫°o s·∫£n ph·∫©m
            $product = Product::create([
                'product_code' => $product_code,
                'name' => $request->name,
                'slug' => Str::slug($request->name),
                'brand_id' => $request->brand_id,
                'catalogue_id' => $request->catalogue_id,
                'origin' => $request->origin,
                'style' => $request->style,
                'fragrance_group' => $request->fragrance_group,
                'description' => $request->description,
                'image' => $imagePath,
                'gender' => $request->gender ?? 'Unisex',
                'status' => $request->status,
            ]);

            if (!$product) {
                throw new \Exception('L·ªói khi t·∫°o s·∫£n ph·∫©m');
            }

            // üñºÔ∏è X·ª≠ l√Ω ·∫£nh ph·ª•
            if ($request->hasFile('images')) {
                foreach ($request->file('images') as $subImage) {
                    if ($subImage->isValid()) {
                        $subImagePath = $subImage->store('product_images', 'public');
                        Images::create([
                            'product_id' => $product->id,
                            'image' => $subImagePath,
                        ]);
                    }
                }
            }

            // üîç X·ª≠ l√Ω bi·∫øn th·ªÉ s·∫£n ph·∫©m (n·∫øu c√≥)
            if ($request->has('variants') && !empty($request->variants)) {
                $variants = json_decode($request->variants, true);
                Log::info('D·ªØ li·ªáu bi·∫øn th·ªÉ:', ['variants' => $variants]);

                if (!empty($variants) && is_array($variants)) {
                    foreach ($variants as $variant) {
                        // Ki·ªÉm tra xem c√°c tr∆∞·ªùng b·∫Øt bu·ªôc c√≥ t·ªìn t·∫°i kh√¥ng
                        if (
                            empty($variant['attributes']) ||
                            !isset($variant['price']) ||
                            !isset($variant['stock'])
                        ) {
                            Log::error('Bi·∫øn th·ªÉ thi·∫øu th√¥ng tin b·∫Øt bu·ªôc', ['variant' => $variant]);
                            continue;
                        }

                        // L·∫•y gi√° tr·ªã t·ª´ attributes
                        $attributes = $variant['attributes'];
                        $size = $attributes[0] ?? 'N/A';
                        $concentration = $attributes[1] ?? 'N/A';
                        $specialEdition = $attributes[2] ?? 'N/A';

                        // Ki·ªÉm tra bi·∫øn th·ªÉ tr√πng l·∫∑p
                        $existingVariant = ProductVariant::where('product_id', $product->id)
                            ->where('size', $size)
                            ->where('concentration', $concentration)
                            ->where('special_edition', $specialEdition)
                            ->first();

                        if ($existingVariant) {
                            throw new \Exception('Bi·∫øn th·ªÉ ƒë√£ t·ªìn t·∫°i trong s·∫£n ph·∫©m');
                        }

                        $productVariant = ProductVariant::create([
                            'product_id' => $product->id,
                            'size' => $size,
                            'concentration' => $concentration,
                            'special_edition' => $specialEdition,
                            'price' => (float) ($variant['price']),
                            'price_sale' => isset($variant['price_sale']) ? (float) $variant['price_sale'] : null,
                            'stock_quantity' => (int) ($variant['stock'] ?? 0),
                            'sku' => $variant['sku'] ?? 'SKU-' . strtoupper(Str::random(8)),
                            'status' => $variant['status'] ?? 'active',
                        ]);

                        if ($productVariant) {
                            if (!empty($variant['attributes']) && is_array($variant['attributes'])) {
                                foreach ($variant['attributes'] as $attrValue) {
                                    $attributeValue = AttributeValue::where('value', trim($attrValue))->first();

                                    if ($attributeValue) {
                                        ProductVariantAttribute::create([
                                            'product_variant_id' => $productVariant->id,
                                            'attribute_id' => $attributeValue->attribute_id,
                                            'attribute_value_id' => $attributeValue->id,
                                        ]);
                                    }
                                }
                            }
                        }
                    }
                }
            }

            DB::commit();
            return redirect()->route('admin.product')->with('success', 'Th√™m s·∫£n ph·∫©m th√†nh c√¥ng');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('L·ªói khi t·∫°o s·∫£n ph·∫©m:', ['error' => $e->getMessage()]);
            return redirect()->back()
                ->withInput()
                ->with('error', 'L·ªói khi t·∫°o s·∫£n ph·∫©m: ' . $e->getMessage());
        }
    }

    public function show($id)
    {
        $title = 'Detail Product';
        $catalogues = Catalogue::all();

        // L·∫•y s·∫£n ph·∫©m c√πng c√°c quan h·ªá li√™n quan
        $product = Product::with([
            'catalogue',
            'brand',
            'comments.user',
            'variants.product_variant_attributes.attribute',
            'variants.product_variant_attributes.attributeValue'
        ])->findOrFail($id);

        $description_images = Images::where('product_id', $id)->get();

        // Chu·∫©n b·ªã danh s√°ch thu·ªôc t√≠nh gi·ªëng b√™n ngo√†i frontend
        $attributes = [];
        foreach ($product->variants as $variant) {
            foreach ($variant->product_variant_attributes as $pivot) {
                $attrName = $pivot->attribute->name;
                $attrValue = $pivot->attributeValue->value;

                if (!isset($attributes[$attrName])) {
                    $attributes[$attrName] = [];
                }

                if (!in_array($attrValue, $attributes[$attrName])) {
                    $attributes[$attrName][] = $attrValue;
                }
            }
        }

        // X·ª≠ l√Ω lo·∫°i b·ªè tr√πng l·∫∑p n·∫øu c√≥
        foreach ($attributes as $key => $values) {
            $attributes[$key] = array_unique($values);
        }

        return view('admin.product.show', compact(
            'product',
            'catalogues',
            'description_images',
            'title',
            'attributes'
        ));
    }

    public function edit($id)
    {
        $title = 'Edit Product';
        $catalogues = Catalogue::all();
        $brands = Brand::all();
        $attributes = Attribute::with('values')->get(); // L·∫•y danh s√°ch thu·ªôc t√≠nh c√πng gi√° tr·ªã c·ªßa ch√∫ng

        $product = Product::with('variants.product_variant_attributes.attribute', 'variants.product_variant_attributes.attributeValue')->findOrFail($id);

        $description_images = Images::where('product_id', $id)->pluck('image');

        return view('admin.product.edit', compact(
            'product',
            'catalogues',
            'brands',
            'attributes',
            'title',
            'description_images'
        ));
    }

    public function update(Request $request, $id)
    {
        $request->validate([
            'product_code' => 'required|unique:products,product_code,' . $id,
            'name' => 'required|string|max:255',
            'brand_id' => 'required|exists:brands,id',
            'catalogue_id' => 'required|exists:catalogues,id',
            'origin' => 'nullable|string|max:255',
            'style' => 'nullable|string|max:255',
            'fragrance_group' => 'required|string|max:255',
            'description' => 'nullable|string',
            'image' => 'nullable|image|max:2048',
            'images.*' => 'nullable|image|max:2048',
            'variants' => 'nullable|string',
            'status' => 'required|in:1,2',
        ]);
    
        DB::beginTransaction();
        try {
            $product = Product::findOrFail($id);
    
            // üì∏ X·ª≠ l√Ω ·∫£nh ch√≠nh
            $imagePath = $request->hasFile('image') ? $request->file('image')->store('products', 'public') : null;
    
            // üîÑ C·∫≠p nh·∫≠t th√¥ng tin s·∫£n ph·∫©m
            $product->update([
                'product_code' => $request->product_code,
                'name' => $request->name,
                'slug' => Str::slug($request->name),
                'brand_id' => $request->brand_id,
                'catalogue_id' => $request->catalogue_id,
                'origin' => $request->origin,
                'style' => $request->style,
                'fragrance_group' => $request->fragrance_group,
                'description' => $request->description,
                'image' => $imagePath ?? $product->image,
                'gender' => $request->gender ?? 'Unisex',
                'status' => $request->status,
            ]);
    
            // üñºÔ∏è C·∫≠p nh·∫≠t ·∫£nh ph·ª•
            if ($request->hasFile('images')) {
                $product->images()->delete();
                foreach ($request->file('images') as $subImage) {
                    if ($subImage->isValid()) {
                        $subImagePath = $subImage->store('product_images', 'public');
                        Images::create([
                            'product_id' => $product->id,
                            'image' => $subImagePath,
                        ]);
                    }
                }
            }
    
            // üîç C·∫≠p nh·∫≠t bi·∫øn th·ªÉ s·∫£n ph·∫©m
            if ($request->has('variants') && !empty($request->variants)) {
                $variants = json_decode($request->variants, true);
                Log::info('D·ªØ li·ªáu bi·∫øn th·ªÉ c·∫≠p nh·∫≠t:', ['variants' => $variants]);
    
                if (!empty($variants) && is_array($variants)) {
                    $keepVariantIds = [];
    
                    foreach ($variants as $variant) {
                        if (empty($variant['attributes']) || !isset($variant['price']) || !isset($variant['stock'])) {
                            Log::error('Bi·∫øn th·ªÉ thi·∫øu th√¥ng tin b·∫Øt bu·ªôc', ['variant' => $variant]);
                            continue;
                        }
    
                        $attributes = $variant['attributes'];
                        $size = $attributes[0] ?? 'N/A';
                        $concentration = $attributes[1] ?? 'N/A';
                        $specialEdition = $attributes[2] ?? 'N/A';
    
                        // N·∫øu c√≥ ID, c·∫≠p nh·∫≠t bi·∫øn th·ªÉ hi·ªán c√≥
                        if (!empty($variant['id'])) {
                            $existingVariant = ProductVariant::find($variant['id']);
                            if ($existingVariant && $existingVariant->product_id == $product->id) {
                                $existingVariant->update([
                                    'price' => (float) $variant['price'],
                                    'price_sale' => (float) ($variant['price_sale'] ?? 0.00),
                                    'stock_quantity' => (int) $variant['stock'],
                                    'status' => $variant['status'] ?? 'active',
                                ]);
                                $keepVariantIds[] = $existingVariant->id;
    
                                Log::info('C·∫≠p nh·∫≠t bi·∫øn th·ªÉ:', [
                                    'variant_id' => $existingVariant->id,
                                    'old_price' => $existingVariant->getOriginal('price'),
                                    'new_price' => (float) $variant['price'],
                                    'old_price_sale' => $existingVariant->getOriginal('price_sale'),
                                    'new_price_sale' => (float) ($variant['price_sale'] ?? 0.00),
                                    'old_stock' => $existingVariant->getOriginal('stock_quantity'),
                                    'new_stock' => (int) $variant['stock']
                                ]);
                            }
                        } else {
                            // N·∫øu kh√¥ng c√≥ ID, t·∫°o bi·∫øn th·ªÉ m·ªõi
                            $existingVariant = ProductVariant::where('product_id', $product->id)
                                ->where('size', $size)
                                ->where('concentration', $concentration)
                                ->where('special_edition', $specialEdition)
                                ->first();
    
                            if ($existingVariant) {
                                // N·∫øu bi·∫øn th·ªÉ ƒë√£ t·ªìn t·∫°i, c·∫≠p nh·∫≠t n√≥
                                $existingVariant->update([
                                    'price' => (float) $variant['price'],
                                    'price_sale' => (float) ($variant['price_sale'] ?? 0.00),
                                    'stock_quantity' => (int) $variant['stock'],
                                    'status' => $variant['status'] ?? 'active',
                                ]);
                                $keepVariantIds[] = $existingVariant->id;
                            } else {
                                // T·∫°o bi·∫øn th·ªÉ m·ªõi
                                $newVariant = ProductVariant::create([
                                    'product_id' => $product->id,
                                    'size' => $size,
                                    'concentration' => $concentration,
                                    'special_edition' => $specialEdition,
                                    'price' => (float) $variant['price'],
                                    'price_sale' => (float) ($variant['price_sale'] ?? 0.00),
                                    'stock_quantity' => (int) $variant['stock'],
                                    'sku' => $variant['sku'] ?? 'SKU-' . strtoupper(Str::random(8)),
                                    'status' => $variant['status'] ?? 'active',
                                ]);
    
                                if ($newVariant) {
                                    $keepVariantIds[] = $newVariant->id;
                                    if (!empty($variant['attributes']) && is_array($variant['attributes'])) {
                                        foreach ($variant['attributes'] as $attrValue) {
                                            $attributeValue = AttributeValue::where('value', trim($attrValue))->first();
                                            if ($attributeValue) {
                                                ProductVariantAttribute::create([
                                                    'product_variant_id' => $newVariant->id,
                                                    'attribute_id' => $attributeValue->attribute_id,
                                                    'attribute_value_id' => $attributeValue->id,
                                                ]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
    
                    // X√≥a c√°c bi·∫øn th·ªÉ kh√¥ng c√≤n trong danh s√°ch c·∫≠p nh·∫≠t
                    ProductVariant::where('product_id', $product->id)
                        ->whereNotIn('id', $keepVariantIds)
                        ->delete();
                }
            }
    
            DB::commit();
            return redirect()->route('admin.product')->with('success', 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('L·ªói khi c·∫≠p nh·∫≠t s·∫£n ph·∫©m:', ['error' => $e->getMessage()]);
            return redirect()->back()->with('error', 'L·ªói khi c·∫≠p nh·∫≠t s·∫£n ph·∫©m: ' . $e->getMessage());
        }
    }

    public function delete($id)
    {
        $product = Product::findOrFail($id);

        $product->delete();
        Images::where('product_id', $product->id)->delete();

        return back()->with('success', 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c ƒë∆∞a v√†o th√πng r√°c');
    }

    public function trash()
    {
        $products = Product::onlyTrashed()->with('catalogue')->paginate(10);
        return view('admin.product.trash', compact('products'));
    }

    public function restore($id)
    {
        $product = Product::withTrashed()->findOrFail($id);
        $product->restore();

        return redirect()->route('admin.trash.product')->with('success', ' S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi');
    }

    public function foreDelete($id)
    {
        $product = Product::withTrashed()->findOrFail($id);
        $product->forceDelete();
        return redirect()->route('admin.product.trash')->with('success', 'X√≥a s·∫£n ph·∫©m th√†nh c√¥ng');
    }

    /**
     * Thay ƒë·ªïi tr·∫°ng th√°i s·∫£n ph·∫©m
     */
    public function toggleStatus($id)
    {
        $product = Product::findOrFail($id);
        
        // Chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i
        $newStatus = $product->status == Product::STATUS_ACTIVE 
            ? Product::STATUS_INACTIVE 
            : Product::STATUS_ACTIVE;
            
        $product->status = $newStatus;
        $product->save();

        $statusText = $newStatus == Product::STATUS_ACTIVE ? 'ƒëang kinh doanh' : 'ng·ª´ng kinh doanh';
        return redirect()->back()->with('success', "ƒê√£ chuy·ªÉn tr·∫°ng th√°i s·∫£n ph·∫©m sang {$statusText}");
    }

    public function delete_img($id)
    {
        $delete_img = Images::find($id);
        if (File::exists('images/' . $delete_img->image)) {
            File::delete('images/' . $delete_img->image);
        }
        $delete_img->delete();
        return back();
    }

    /**
     * C·∫≠p nh·∫≠t gi√° v√† s·ªë l∆∞·ª£ng c·ªßa bi·∫øn th·ªÉ
     */
    public function updateVariantPrice(Request $request)
    {
        try {
            $request->validate([
                'variant_id' => 'required|exists:product_variants,id',
                'price' => 'required|numeric|min:0',
                'price_sale' => 'nullable|numeric|min:0',
                'stock_quantity' => 'required|integer|min:0',
            ]);

            $variant = ProductVariant::findOrFail($request->variant_id);

            // Log gi√° tr·ªã c≈© tr∆∞·ªõc khi c·∫≠p nh·∫≠t
            Log::info('C·∫≠p nh·∫≠t gi√° bi·∫øn th·ªÉ:', [
                'variant_id' => $variant->id,
                'old_price' => $variant->price,
                'new_price' => $request->price,
                'old_price_sale' => $variant->price_sale,
                'new_price_sale' => $request->price_sale,
                'old_stock' => $variant->stock_quantity,
                'new_stock' => $request->stock_quantity
            ]);

            // C·∫≠p nh·∫≠t gi√° tr·ªã m·ªõi
            $variant->update([
                'price' => $request->price,
                'price_sale' => $request->price_sale ?: null,
                'stock_quantity' => $request->stock_quantity
            ]);

            return response()->json([
                'success' => true,
                'message' => 'C·∫≠p nh·∫≠t gi√° bi·∫øn th·ªÉ th√†nh c√¥ng',
                'variant' => [
                    'id' => $variant->id,
                    'price' => $variant->price,
                    'price_sale' => $variant->price_sale,
                    'stock_quantity' => $variant->stock_quantity
                ]
            ]);
        } catch (\Exception $e) {
            Log::error('L·ªói khi c·∫≠p nh·∫≠t gi√° bi·∫øn th·ªÉ:', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return response()->json([
                'success' => false,
                'message' => 'C√≥ l·ªói x·∫£y ra: ' . $e->getMessage()
            ], 500);
        }
    }
}
